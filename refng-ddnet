#FROM alpine:latest AS fetch
#RUN apk add --no-cache git
#RUN git clone https://github.com/k0rae/teeworlds --recurse-submodules -j 8 --branch refng --progress

FROM alpine:latest AS build
RUN apk add --no-cache \
		cmake \
		curl-dev \
		make \
		g++ \
		gcc \
		python3 \
		sqlite-dev \
		zlib-dev \
		rust-dbg \
		cargo
#COPY --from=fetch /teeworlds /teeworlds
ADD refng-git /teeworlds
#COPY refng-git /teeworlds
WORKDIR /teeworlds/build
RUN cmake .. -Wno-dev \
		-DCLIENT=OFF
RUN make install -j$(nproc)

FROM alpine:latest
RUN apk add --no-cache curl-dev libstdc++ sqlite-dev
COPY --from=build /usr/local/share/ddnet/ /usr/local/share/ddnet/
COPY --from=build /usr/local/bin/ /usr/local/bin/
WORKDIR /usr/local/share/ddnet/data/
ENTRYPOINT ["DDNet_srv"]
